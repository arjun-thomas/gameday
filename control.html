<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G-CONTROL V2 // REFINED</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            background: #000;
            color: #fff;
            font-family: 'Space Mono', monospace;
            overscroll-behavior: none;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
            font-size: 16px !important;
        }

        .scroll-area {
            height: calc(100vh - 280px);
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .icon-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #0a0a0a;
            padding: 10px;
            border-top: 1px solid #222;
            display: flex;
            justify-content: center;
            gap: 12px;
            z-index: 100;
        }

        .icon-btn {
            background: #1a1a1a;
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 7.5px;
            font-weight: 900;
            color: #666;
            transition: all 0.2s;
            min-width: 60px;
        }

        .icon-btn.active {
            background: #ffb800;
            color: #000;
        }

        .icon-btn svg {
            width: 18px;
            height: 18px;
            margin-bottom: 3px;
        }
    </style>
</head>

<body class="p-4 pt-20">
    <div id="setup-view">
        <header
            class="fixed top-0 left-0 right-0 p-4 bg-black/95 z-50 flex justify-between items-center border-b border-white/5">
            <span id="status-pill"
                class="text-[8px] font-black text-zinc-500 uppercase tracking-widest bg-zinc-900 px-3 py-1 rounded">DISCONNECTED</span>
            <div class="flex gap-4 text-[12px] font-black text-zinc-500">
                <button onclick="exportGame()">ðŸ’¾</button>
                <label class="cursor-pointer">ðŸ“‚<input type="file" class="hidden" onchange="importGame(event)"></label>
            </div>
        </header>

        <div class="bg-zinc-900/50 p-2 rounded-lg border border-white/5 mb-4 flex gap-2">
            <input id="manual-id" type="number" placeholder="NODE ID"
                class="flex-1 bg-transparent border-none text-white font-mono text-sm outline-none px-2 uppercase">
            <button onclick="connectToTV(document.getElementById('manual-id').value)"
                class="text-accent px-2 py-1 text-[10px] font-black">LINK</button>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-4">
            <div class="bg-zinc-900/50 p-3 rounded-lg border border-white/5 flex items-center justify-between">
                <span class="text-[9px] font-black text-zinc-500 italic">TOTALS</span>
                <input type="checkbox" id="show-totals" onchange="saveAndSync()" class="accent-yellow-600">
            </div>
            <div class="bg-zinc-900/50 p-3 rounded-lg border border-white/5 flex items-center justify-between">
                <span class="text-[9px] font-black text-zinc-500 italic">WIN</span>
                <select id="win-mode" onchange="saveAndSync()"
                    class="bg-transparent text-[10px] font-black text-yellow-600 outline-none">
                    <option value="low">LOW</option>
                    <option value="high">HIGH</option>
                </select>
            </div>
        </div>

        <div class="bg-zinc-900 p-3 rounded-xl border border-white/10 mb-6 flex gap-2">
            <input id="new-player" type="text" placeholder="ADD NEW PLAYER"
                class="flex-1 bg-transparent p-2 text-white font-black text-xs outline-none focus:text-accent"
                onkeydown="if(event.key==='Enter')addPlayer()">
            <button onclick="addPlayer()" class="bg-accent text-black px-4 rounded-lg font-black text-xl">+</button>
        </div>

        <div id="player-inputs" class="scroll-area space-y-2"></div>

        <div class="icon-nav">
            <button onclick="softReset()" class="icon-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M23 4v6h-6" />
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                </svg>
                RESET
            </button>
            <button onclick="submitRound()" class="icon-btn active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                    stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12" />
                </svg>
                ROUND
            </button>
            <button onclick="finalizeMatch()" class="icon-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                    stroke-linejoin="round">
                    <circle cx="12" cy="8" r="7" />
                    <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" />
                </svg>
                WINNER
            </button>
        </div>
    </div>

    <div id="stats-view" class="hidden fixed inset-0 bg-black z-[200] p-6 overflow-y-auto pb-48">
        <h1 class="text-accent font-black text-2xl mb-4 italic">MATCH SUMMARY</h1>
        <div id="stats-content" class="space-y-6"></div>
        <div class="fixed bottom-6 left-6 right-6 flex flex-col gap-3">
            <button onclick="shareStats()"
                class="bg-accent text-black font-black py-4 rounded-xl text-[10px] tracking-widest uppercase shadow-lg active:scale-95 transition-all">
                Share Stats (Image)
            </button>
            <button onclick="document.getElementById('stats-view').classList.add('hidden')"
                class="bg-white text-black font-black py-3 rounded-lg text-[9px] uppercase shadow-lg border-2 border-black/20 active:scale-95 transition-all">
                Back to Match
            </button>
        </div>
    </div>

    <script>
        let state = JSON.parse(localStorage.getItem('game_state_v2_f')) || {
            players: [], dealerIdx: 0, lowWins: true, showTotals: false,
            startTime: null, endTime: null, date: null
        };
        if (!state.date) state.date = new Date().toLocaleDateString('en-GB');
        let liveScores = {}; let focusedPlayerId = null; let conn = null; let wakeLock = null;
        let tvId = null;
        const peer = new Peer();

        const winPhrases = ["Ascended to godhood.", "Simply outplayed everyone.", "Made it look too easy.", "The ultimate tactician."];
        const losePhrases = ["Should stick to board games.", "Better luck next year.", "Absolute nightmare scenario.", "Lost in the matrix."];
        const midPhrases = ["Safe, but unremarkable.", "Survived the onslaught.", "Doing just enough."];
        const groupPhrases = [
            "A legendary gathering of tactical masterminds and absolute chaos. Today's match was a masterclass in risk-taking and pixel-perfect decision making.",
            "The air was thick with competition and the scent of digital glory. Some played like legends, others played like they were using a steering wheel for a flight sim.",
            "A roller coaster of emotions where fortunes shifted with every round. We witnessed the birth of a champion and the tragic fall of those who tried too hard.",
            "Today's session was characterized by unexpected turns and a healthy amount of table-flipping energy."
        ];

        const urlParams = new URLSearchParams(window.location.search);
        peer.on('open', () => {
            tvId = urlParams.get('id');
            if (tvId) connectToTV(tvId);
        });

        // Peer Auto-Reconnect
        peer.on('disconnected', () => {
            console.log("Peer disconnected. Reconnecting...");
            peer.reconnect();
        });

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                }
            } catch (err) { console.error(`${err.name}, ${err.message}`); }
        }

        function connectToTV(id) {
            tvId = id;
            conn = peer.connect(id);
            setupConn();
        }

        function setupConn() {
            if (!conn) return;
            conn.on('open', () => {
                document.getElementById('status-pill').innerText = "LINKED: " + tvId;
                document.getElementById('status-pill').classList.replace('text-zinc-500', 'text-green-500');
                document.getElementById('status-pill').classList.remove('animate-pulse');
                requestWakeLock();
                saveAndSync();
            });

            conn.on('close', () => {
                document.getElementById('status-pill').innerText = "RECONNECTING...";
                document.getElementById('status-pill').classList.replace('text-green-500', 'text-orange-500');
                document.getElementById('status-pill').classList.add('animate-pulse');
                setTimeout(() => connectToTV(tvId), 2000);
            });

            conn.on('error', (err) => {
                console.error("Connection error:", err);
                setTimeout(() => connectToTV(tvId), 5000);
            });
        }

        function addPlayer() {
            const el = document.getElementById('new-player'); if (!el.value) return;
            state.players.push({ id: Date.now(), name: el.value.toUpperCase(), scores: [], greyed: false });
            el.value = ""; render();
        }

        function render() {
            const container = document.getElementById('player-inputs');
            container.innerHTML = state.players.map((p, i) => `
                <div class="flex items-center gap-3 bg-zinc-900/40 p-3 rounded-xl ${p.greyed ? 'opacity-20' : ''} border ${state.dealerIdx === i ? 'border-accent/40 bg-zinc-800/50' : 'border-white/5'}">
                    <input type="checkbox" ${p.greyed ? 'checked' : ''} onchange="state.players[${i}].greyed=!state.players[${i}].greyed; render();" class="accent-yellow-600">
                    <div class="flex-1 font-black text-xs uppercase px-4 ${state.dealerIdx === i ? 'text-accent' : 'text-zinc-500'}">
                        ${state.dealerIdx === i ? 'â—ˆ ' : ''}${p.name}
                    </div>
                    <input type="number" id="in-${i}" 
                        class="w-20 bg-black p-3 text-right rounded-lg font-black text-white outline-none border border-zinc-800 focus:border-accent" 
                        placeholder="0" 
                        oninput="handleScoreInput(event, ${i})" 
                        onkeydown="handleKeyNav(event, ${i})"
                        onfocus="focusedPlayerId=state.players[${i}].id; saveAndSync();"
                        onblur="focusedPlayerId=null; saveAndSync();">
                </div>`).join('');
            saveAndSync();
        }

        function handleKeyNav(e, idx) { if (e.key === 'Enter') { e.preventDefault(); const next = (idx + 1) % state.players.length; document.getElementById(`in-${next}`).focus(); } }

        function handleScoreInput(e, idx) {
            if (!state.startTime) state.startTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            liveScores[state.players[idx].id] = e.target.value;
            saveAndSync();
        }

        function submitRound() {
            state.players.forEach((p, i) => { const el = document.getElementById(`in-${i}`); p.scores.push(parseInt(el.value) || 0); el.value = ""; });
            state.dealerIdx = (state.dealerIdx + 1) % state.players.length;
            liveScores = {};
            saveAndSync({ type: 'ROUND_REVEAL' });
            render();
        }

        function finalizeMatch() {
            state.endTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            saveAndSync({ type: 'CHAMPION_REVEAL' });
            const active = state.players.filter(p => !p.greyed).map(p => ({ name: p.name, total: p.scores.reduce((a, b) => a + b, 0) }));
            active.sort((a, b) => state.lowWins ? a.total - b.total : b.total - a.total);

            document.getElementById('stats-view').classList.remove('hidden');
            document.getElementById('stats-content').innerHTML = `
                <div class="border-b border-white/5 pb-4 mb-4 font-mono text-[9px] text-zinc-600 flex justify-between">
                    <div>DATE: ${state.date}</div>
                    <div>START: ${state.startTime || '--:--'} | END: ${state.endTime}</div>
                </div>
                <div class="bg-zinc-900 p-6 rounded-2xl border border-accent/20">
                    <p class="text-zinc-500 font-black text-[10px] tracking-widest uppercase mb-2">Champion</p>
                    <p class="text-5xl font-black text-white mb-2 leading-tight">${active[0].name}</p>
                    <p class="text-accent font-black italic">"${winPhrases[Math.floor(Math.random() * winPhrases.length)]}"</p>
                </div>
                <div class="space-y-4">
                    ${active.map((p, i) => `
                        <div class="p-5 bg-zinc-900/50 rounded-xl border border-white/5">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-black text-white">${i + 1}. ${p.name}${i === 0 ? ' ðŸ‘‘' : ''}</span>
                                <span class="text-accent font-black">${p.total}</span>
                            </div>
                            <p class="text-xs text-zinc-500 italic">
                                ${i === 0 ? "Legendary performance." : i === active.length - 1 ? losePhrases[Math.floor(Math.random() * losePhrases.length)] : midPhrases[Math.floor(Math.random() * midPhrases.length)]}
                            </p>
                        </div>
                    `).join('')}
                </div>`;
        }

        function softReset() {
            if (confirm("Keep players but reset scores?")) {
                state.players.forEach(p => p.scores = []);
                state.dealerIdx = 0;
                state.startTime = null;
                state.endTime = null;
                liveScores = {};
                saveAndSync({ type: 'CLEAR_OVERLAYS' });
                render();
            }
        }
        function saveAndSync(extra) {
            state.lowWins = document.getElementById('win-mode').value === 'low';
            state.showTotals = document.getElementById('show-totals').checked;
            localStorage.setItem('game_state_v2_f', JSON.stringify(state));
            if (conn?.open) conn.send({ type: 'SYNC', ...state, liveScores, focusedPlayerId, ...extra });
        }

        function exportGame() { const b = new Blob([JSON.stringify(state)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'match.json'; a.click(); }
        function importGame(e) { const r = new FileReader(); r.onload = (v) => { state = JSON.parse(v.target.result); render(); }; r.readAsText(e.target.files[0]); }

        async function shareStats() {
            const content = document.getElementById('stats-content');
            const canvas = await html2canvas(content, { backgroundColor: '#000', scale: 2 });
            canvas.toBlob(blob => {
                const file = new File([blob], "match_stats.png", { type: "image/png" });
                if (navigator.share) {
                    navigator.share({
                        files: [file],
                        title: 'Match Stats',
                        text: 'Check out the game results!'
                    }).catch(console.error);
                } else {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = "match_stats.png";
                    a.click();
                }
            });
        }

        // Heartbeat to keep connection alive and notify TV
        setInterval(() => {
            if (conn?.open && tvId) saveAndSync();
        }, 5000);

        window.onload = () => {
            document.getElementById('show-totals').checked = state.showTotals;
            document.getElementById('win-mode').value = state.lowWins ? 'low' : 'high';
            render();
            // Re-request wake lock if tab becomes visible again
            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    requestWakeLock();
                }
            });
        };
    </script>
</body>

</html>