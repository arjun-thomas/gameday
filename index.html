<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAACHUTTAN V2 // REFINED</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Orbitron:wght@400;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --accent: #ffb800;
            --bg: #08080a;
        }

        body {
            background: var(--bg);
            color: #fff;
            font-family: 'Space Mono', monospace;
            overflow: hidden;
            margin: 0;
            text-shadow: 0 0 10px rgba(255, 184, 0, 0.3);
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5vh 5vw;
        }

        .retro-title {
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 0.15em;
        }

        /* CRT Effect */
        body::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            z-index: 999;
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.4;
        }

        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(rgba(255, 184, 0, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 184, 0, 0.05) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: perspective(500px) rotateX(60deg);
            transform-origin: center bottom;
            bottom: -20%;
            opacity: 0.2;
            z-index: -1;
        }

        table {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            border-spacing: 0 20px;
            border-collapse: separate;
        }

        th {
            color: #52525b;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            font-size: clamp(0.8rem, 2vw, 1.25rem);
            padding: 1rem 0.5rem;
            font-weight: 900;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        td {
            padding: clamp(0.5rem, 2vh, 2rem);
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
            font-size: clamp(1rem, 5vw, 6rem);
        }

        tr td:first-child {
            border-radius: 12px 0 0 12px;
            border-right: none;
            text-align: left;
        }

        tr td:last-child {
            border-radius: 0 12px 12px 0;
            border-left: none;
        }

        .dealer-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--accent);
            margin-right: 15px;
            vertical-align: middle;
        }

        .live-score td {
            filter: blur(4px);
            opacity: 0.25;
            transition: all 0.5s ease;
        }

        .live-score td.sharp {
            filter: none !important;
            opacity: 1 !important;
            font-weight: 900;
            color: var(--accent);
        }

        .current-round td {
            background: rgba(255, 184, 0, 0.05);
            border: 1px solid rgba(255, 184, 0, 0.15);
            color: #fff;
            font-weight: 900;
            filter: none;
            opacity: 1;
        }

        .prev-round td {
            opacity: 0.4;
            filter: contrast(0.8);
        }

        .reveal-container {
            animation: slideIn 0.8s cubic-bezier(0.23, 1, 0.32, 1);
        }

        @keyframes slideIn {
            from {
                transform: scale(0.9) translateY(50px);
                opacity: 0;
            }

            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .ecg-path {
            stroke-dasharray: 200;
            stroke-dashoffset: 200;
            animation: ecg-pulse 3s linear infinite;
        }

        @keyframes ecg-pulse {
            0% {
                stroke-dashoffset: 200;
            }

            50% {
                stroke-dashoffset: 0;
            }

            100% {
                stroke-dashoffset: -200;
            }
        }

        /* Podium Styles */
        .podium-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .rank-badge {
            padding: 4px 12px;
            font-weight: 900;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .p-1 {
            height: 350px;
            width: 350px;
            background: linear-gradient(to top, rgba(255, 184, 0, 0.2), transparent);
            border-top: 4px solid var(--accent);
        }

        .p-2 {
            height: 250px;
            width: 300px;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.1), transparent);
            border-top: 2px solid #a1a1aa;
        }

        .p-3 {
            height: 180px;
            width: 300px;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.05), transparent);
            border-top: 2px solid #71717a;
        }

        /* Disconnect Warning */
        #conn-warning {
            position: fixed;
            top: 40px;
            right: 40px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
            transition: all 0.5s ease;
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        #conn-warning.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .warn-pulse {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>

<body class="">
    <div id="conn-warning">
        <div class="warn-pulse"></div>
        Controller Disconnected - Waiting...
    </div>
    <div class="grid-bg"></div>
    <canvas id="bg-canvas"></canvas>

    <header
        class="w-full flex justify-between items-center mb-10 border-b border-white/5 pb-6 opacity-90 hover:opacity-100 transition-opacity">
        <div class="flex items-center gap-6">
            <div class="p-4 border border-accent/20 rounded-xl bg-zinc-900/40">
                <h1 class="text-accent retro-title text-lg font-black mb-0.5">Ledger: GAACHUTTAN <span
                        class="text-white/30 text-[10px]">MK-II</span></h1>
                <p class="text-[6px] tracking-[0.4em] text-zinc-600 font-black uppercase">Tactile Game Score Ledger
                    System</p>
            </div>
            <div id="room-id"
                class="px-5 py-2.5 bg-zinc-900/60 rounded-xl font-mono text-accent text-sm border border-white/5 tracking-widest flex items-center gap-4">
                <svg class="w-8 h-4 text-accent" viewBox="0 0 100 40" fill="none">
                    <path d="M0 20 H30 L35 5 L45 35 L50 20 H100" stroke="currentColor" stroke-width="4"
                        stroke-linecap="round" stroke-linejoin="round" class="ecg-path" />
                </svg>
                <div class="flex flex-col">
                    <span id="node-label" class="text-[8px] opacity-40">NODE_ID</span>
                    <span id="node-val">AWAIT_UPLINK</span>
                </div>
                <div class="w-px h-6 bg-white/10 mx-2"></div>
                <div class="flex flex-col">
                    <span class="text-[8px] opacity-40 uppercase">Status</span>
                    <span id="uplink-status" class="text-red-500 animate-pulse">OFFLINE</span>
                </div>
            </div>
        </div>
        <div class="text-right">
            <div id="live-clock" class="text-2xl font-black tracking-tighter text-white mb-1"></div>
            <div id="game-date" class="text-[9px] tracking-[0.4em] text-zinc-600 uppercase font-black"></div>
        </div>
    </header>

    <main id="main-content" class="w-full flex-1 flex flex-col items-center justify-center">
        <div id="initial-screen" class="flex flex-col items-center justify-center h-[55vh]">
            <div class="relative group">
                <div class="absolute -inset-2 bg-accent/20 rounded-3xl blur-xl opacity-75 animate-pulse"></div>
                <div id="qrcode" class="relative p-8 bg-white rounded-2xl"></div>
            </div>
            <p class="mt-12 text-xs tracking-[1em] text-accent animate-pulse font-black">SCAN FOR CONTROL INTERFACE</p>
        </div>
        <div id="table-container" class="hidden"></div>
        <div id="reveal-overlay"
            class="hidden fixed inset-0 bg-black/95 z-[50] flex flex-col items-center justify-center p-20"></div>
    </main>

    <script>
        // Particle Background
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function initCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', initCanvas);
        initCanvas();

        // Retro Audio Engine
        const AudioFX = {
            ctx: null,
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play(type) {
                this.init();
                const now = this.ctx.currentTime;
                if (type === 'round') { // Victory chord
                    this.note(440, now, 0.1, 'square'); this.note(554.37, now + 0.1, 0.1, 'square'); this.note(659.25, now + 0.2, 0.4, 'square');
                } else if (type === 'match') { // Major fanfare
                    [523, 659, 783, 1046].forEach((f, i) => this.note(f, now + (i * 0.15), 0.2, 'sawtooth'));
                } else if (type === 'reset') { // Downward sweep
                    this.note(880, now, 0.1, 'sine'); this.note(440, now + 0.1, 0.2, 'sine');
                }
            },
            note(freq, start, dur, type = 'square') {
                const osc = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, start);
                osc.connect(g); g.connect(this.ctx.destination);
                g.gain.setValueAtTime(0.1, start); g.gain.linearRampToValueAtTime(0, start + dur);
                osc.start(start); osc.stop(start + dur);
            }
        };

        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.vx = (Math.random() - 0.5) * 0.4;
                this.vy = (Math.random() - 0.5) * 0.4;
                this.size = Math.random() * 2 + 1;
                this.color = Math.random() > 0.6 ? '#ffb800' : '#ffffff';
                this.opacity = Math.random() * 0.5;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) this.reset();
            }
            draw() { ctx.globalAlpha = this.opacity; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
        }
        for (let i = 0; i < 120; i++) particles.push(new Particle());
        function loop() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(loop); }
        loop();

        const peer = new Peer(localStorage.getItem('tv_v2_id') || Math.floor(1000 + Math.random() * 8999).toString());
        peer.on('open', id => {
            localStorage.setItem('tv_v2_id', id);
            document.getElementById('node-val').innerText = `NODE_${id}`;
            const path = window.location.pathname.endsWith('.html') ? window.location.pathname.replace('index.html', 'control.html') : window.location.pathname + 'control.html';
            const url = `${window.location.origin}${path.replace('//', '/')}?id=${id}`;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 220, height: 220 });
        });

        let disconnectTimer = null;
        let revealLock = false;

        peer.on('connection', conn => {
            document.getElementById('initial-screen').style.display = 'none';
            document.getElementById('table-container').classList.remove('hidden');
            document.getElementById('uplink-status').innerText = "ONLINE";
            document.getElementById('uplink-status').className = "text-green-500";

            conn.on('data', data => {
                document.getElementById('uplink-status').innerText = "ONLINE";
                document.getElementById('uplink-status').className = "text-green-500";
                document.getElementById('conn-warning').classList.remove('visible');
                clearTimeout(disconnectTimer);
                disconnectTimer = setTimeout(() => {
                    document.getElementById('conn-warning').classList.add('visible');
                    document.getElementById('uplink-status').innerText = "LINK LOST";
                    document.getElementById('uplink-status').className = "text-orange-500 animate-pulse";
                }, 7000);

                if (data.type === 'PING') return;
                if (data.type === 'HANDSHAKE') { console.log("Handshake received"); return; }

                if (data.type === 'SYNC') {
                    updateDisplay(data);
                    if (data.isFinalized) { showChampion(data); }
                    else if (!revealLock) document.getElementById('reveal-overlay').classList.add('hidden');
                }
                if (data.type === 'ROUND_REVEAL') {
                    revealLock = true;
                    showRoundWinner(data);
                    AudioFX.play('round');
                    setTimeout(() => {
                        revealLock = false;
                        document.getElementById('reveal-overlay').classList.add('hidden');
                    }, 2000);
                }
                if (data.type === 'CHAMPION_REVEAL') { showChampion(data); AudioFX.play('match'); }
                if (data.type === 'RESET_UI' || data.type === 'CLEAR_OVERLAYS' || data.type === 'CLOSE_OVERLAYS') {
                    revealLock = false;
                    document.getElementById('reveal-overlay').classList.add('hidden');
                    if (data.type === 'RESET_UI') location.reload();
                    if (data.type === 'CLEAR_OVERLAYS') AudioFX.play('reset');
                }
            });

            conn.on('close', () => {
                document.getElementById('conn-warning').classList.add('visible');
                document.getElementById('uplink-status').innerText = "OFFLINE";
                document.getElementById('uplink-status').className = "text-red-500 animate-pulse";
            });
        });

        function updateDisplay({ players, showTotals, dealerIdx, liveScores, focusedPlayerId }) {
            if (!players.length) return;
            let html = `<table><thead><tr><th>RD</th>`;
            players.forEach((p, i) => {
                const isDealer = (i === dealerIdx);
                const isHidden = p.greyed;
                html += `<th class="${isHidden ? 'hidden' : ''} ${isDealer ? 'text-accent font-black' : 'text-zinc-600'} text-xl">
                    <div class="flex items-center gap-2 justify-center">
                        ${isDealer ? '<span class="dealer-dot"></span>' : ''}
                        <span>${p.name}</span>
                    </div>
                </th>`;
            });
            html += `</tr></thead><tbody>`;
            const rounds = players[0].scores.length;
            for (let r = 0; r < rounds; r++) {
                const isCurrent = (r === rounds - 1);
                html += `<tr class="${isCurrent ? 'current-round' : 'prev-round'}"><td class="text-zinc-500 font-mono text-xs">#${String(r + 1).padStart(2, '0')}</td>`;
                players.forEach(p => {
                    const isHidden = p.greyed;
                    html += `<td class="font-black ${isHidden ? 'hidden' : ''}">${p.scores[r]}</td>`;
                });
                html += `</tr>`;
            }
            if (liveScores && Object.keys(liveScores).length > 0) {
                html += `<tr class="live-score"><td class="text-[9px] font-black italic">LIVE</td>`;
                players.forEach(p => {
                    const score = liveScores[p.id];
                    const isHidden = p.greyed;
                    const isFocused = (p.id === focusedPlayerId);
                    const isSharp = !isFocused && score && score !== "" && score !== "..";
                    html += `<td class="font-light italic ${isHidden ? 'hidden' : ''} ${isSharp ? 'sharp' : ''}">${score || '..'}</td>`;
                });
                html += `</tr>`;
            }
            if (showTotals) {
                html += `<tr class="border-t-4 border-accent/20"><td class="text-accent text-[14px] font-black italic">SUM</td>`;
                players.forEach(p => {
                    const isHidden = p.greyed;
                    html += `<td class="${isHidden ? 'hidden' : ''} text-[clamp(2rem,8vw,10rem)] font-black text-white p-2">${p.scores.reduce((a, b) => a + b, 0)}</td>`;
                });
                html += `</tr>`;
            }
            document.getElementById('table-container').innerHTML = html + `</tbody></table>`;
        }

        function showRoundWinner(data) {
            const lastRoundIdx = data.players[0].scores.length - 1;
            const roundScores = data.players.filter(p => !p.greyed).map(p => ({ name: p.name, score: p.scores[lastRoundIdx] }));
            roundScores.sort((a, b) => data.lowWins ? a.score - b.score : b.score - a.score);

            const bestScore = roundScores[0].score;
            const winners = roundScores.filter(s => s.score === bestScore);
            const winnerText = winners.map(w => w.name).join(' & ');
            const isTie = winners.length > 1;

            const overlay = document.getElementById('reveal-overlay');
            overlay.classList.remove('hidden');
            overlay.innerHTML = `
                <div class="reveal-container text-center">
                    <h2 class="retro-title text-accent text-2xl tracking-[1em] mb-12 uppercase">${isTie ? 'STALEMATE DETECTED' : `Round ${lastRoundIdx + 1} Secured`}</h2>
                    <div class="p-20 border-8 border-accent bg-black shadow-[0_0_150px_rgba(255,184,0,0.3)]">
                        <p class="text-[10rem] font-black text-white leading-tight uppercase font-mono">${winnerText}</p>
                        <p class="text-5xl font-mono text-accent mt-8">${isTie ? 'TIE // ' : ''}${bestScore} POINTS</p>
                    </div>
                </div>`;
        }

        function showChampion(data) {
            const active = data.players.filter(p => !p.greyed).map(p => ({ name: p.name, total: p.scores.reduce((a, b) => a + b, 0) }));
            active.sort((a, b) => data.lowWins ? a.total - b.total : b.total - a.total);

            const grouped = [];
            active.forEach(p => {
                const group = grouped.find(g => g.total === p.total);
                if (group) group.players.push(p.name);
                else grouped.push({ total: p.total, players: [p.name] });
            });

            const overlay = document.getElementById('reveal-overlay');
            overlay.classList.remove('hidden');
            overlay.innerHTML = `
                <div class="reveal-container w-full max-w-7xl animate-podium">
                    <h1 class="retro-title text-center text-8xl font-black mb-20 text-white">The Winners</h1>
                    
                    <div class="flex justify-center items-end gap-0 mb-32">
                        <!-- Second -->
                        ${grouped[1] ? `
                        <div class="podium-item p-2">
                            <span class="text-3xl font-black mb-3 text-center px-4 leading-tight">${grouped[1].players.join('<br>')}</span>
                            <span class="rank-badge bg-zinc-400 text-black">RANK 02</span>
                            <span class="text-5xl font-black mb-5">${grouped[1].total}</span>
                        </div>` : ''}
                        
                        <!-- First -->
                        <div class="podium-item p-1">
                            <div class="text-6xl mb-4">ðŸ‘‘</div>
                            <span class="text-5xl font-black mb-3 text-accent text-center px-4 leading-tight">${grouped[0].players.join('<br>')}</span>
                            <span class="rank-badge bg-accent text-black">${grouped[0].players.length > 1 ? 'TIED CHAMPIONS' : 'CHAMPION'}</span>
                            <span class="text-7xl font-black mb-5">${grouped[0].total}</span>
                        </div>
 
                        <!-- Third -->
                        ${grouped[2] ? `
                        <div class="podium-item p-3">
                            <span class="text-2xl font-black mb-3 text-center px-4 leading-tight">${grouped[2].players.join('<br>')}</span>
                            <span class="rank-badge bg-zinc-600 text-white">RANK 03</span>
                            <span class="text-4xl font-black mb-5">${grouped[2].total}</span>
                        </div>` : ''}
                    </div>

                    <!-- Others Table -->
                    ${active.length > 3 ? `
                    <div class="mt-20 border-t-2 border-white/5 pt-10">
                        <table class="!border-spacing-y-2 opacity-60">
                            ${active.filter(p => !grouped.slice(0, 3).some(g => g.total === p.total)).map((p, i) => `
                                <tr>
                                    <td class="text-zinc-600 font-black text-left">#${active.indexOf(p) + 1}</td>
                                    <td class="text-2xl font-black text-center">${p.name}</td>
                                    <td class="text-right text-4xl font-black">${p.total}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>` : ''}
                </div>`;
        }

        setInterval(() => {
            const now = new Date();
            document.getElementById('live-clock').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }).toUpperCase();
            document.getElementById('game-date').innerText = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase();
        }, 1000);
    </script>
</body>

</html>